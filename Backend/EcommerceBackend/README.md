# E-commerce Backend

The application is based on Spring Boot framework, supporting Token based Authentication with JWT and Spring Security.
It uses Spring Data JPA to interact with PostgreSQL Database.

## Use the backend application with Docker

1. Run "./mvnw clean package -DskipTests" to create the backend jar. Alternatively, you can run the Gitlab CI/CD Pipeline which will do the build for you, after which you can download the jar and place it under the project's "target" folder.

2. Run "docker compose up" or "docker compose up -d", if you want your containers to be running in the underground. For stopping the backend, run "docker compose down"

3. See "Interact with the Services" for testing or integrating the APIs

## Use the backend application without Docker

### Run the Database

The first time you execute the procedure on MacOS/Linux:

```
docker load < mon-pg.tar docker run --name mon-pg -p 5432:5432 -e POSTGRES_PASSWORD=xyz -d postgres docker start mon-pg
```

And on Windows:

```
Get-Content mon-pg.tar | docker load; docker run --name mon-pg -p 5432:5432 -e POSTGRES_PASSWORD=xyz -d postgres; docker start mon-pg
```

Otherwise, just make sure that the container "mon-ecom-pg" is active, since it contains the PostgreSQL Server.
Instead, the e-commerce schema is automatically generated by the application thanks to Hibernate.

### Set the following environment variable with the POSTGRES_PASSWORD:

```
export POSTGRES_DB_PASSWORD= POSTGRES_PASSWORD
```

### Run the Spring Boot application

```
./mvnw spring-boot:run
```

### Run the following SQL insert statements

The first time you run the application, insert these data into the Database by hand (since we don't have any kind of APIs for this of operation yet):

```
INSERT INTO roles(name) VALUES('ROLE_USER');
INSERT INTO roles(name) VALUES('ROLE_ADMIN');

INSERT INTO shopping_cart(login_user_id) VALUES(1);
INSERT INTO product_category(category_name) VALUES('food');
INSERT INTO product(description,instock,name,price,product_category_id) VALUES('super random pizza', true,'pizza', 8,1);
INSERT INTO product(description,instock,name,price,product_category_id) VALUES('super test pizza', true,'pizza', 6, 1);
INSERT INTO product(description,instock,name,price,product_category_id) VALUES('random burger', true,'burger', 5, 1);
INSERT INTO product(description,instock,name,price,product_category_id) VALUES('random pasta', true,'pasta', 3, 1);
commit;
```

### Interact with the services

The application automatically generates the documentation about the available endpoints, thanks to Swagger, here:

```
http://localhost:8080/swagger-ui/index.html
```

### Postman

Use this tool to test the endpoints:

1)Test public resources:

```
 GET http://localhost:8080/api/test/all

 RESULT: Public Content.
```

2)Test user resources:

```
- Create an account:

POST http://localhost:8080/api/auth/signup

body: {

    "username": "test123",
    "email": "test123@gmail.com",
    "password": "testpassw",
    "phone": "3456787981",
    "firstname": "test_name",
    "lastname": "test_surname",
    "isbuyer": true,
    "isseller": true,
    "role": ["user"]
}

RESULT: {
    "message": "User successfully registered with basic permissions!",
    "id": 2
}


- Login with the credentials:

POST http://localhost:8080/api/auth/signin

body: {
"username": "test123",
"password": "testpassw"
}

RESULT: {
    "id": 2,
    "username": "test_username",
    "email": "test123@gmail.com",
    "roles": [
        "ROLE_USER"
    ],
    "accessToken": "eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJ0ZXN0X3VzZXJuYW1lIiwiaWF0IjoxNjgxNTQ2ODg2LCJleHAiOjE2ODE2MzMyODZ9.NvMtcFWM3t1dHQa2hFrp_4HA6fRkYARyAq6ZJtPq6hIrUuetsmizZj4j-YZuj1WHMnmJImCYSZCAdrLLAZyMSg",
    "tokenType": "Bearer"
}

- From now on log in use the following test account already inserted in the db:

  body: {
  "username" = "username"
  "password" = "password"
  }

Take note of the generated bear token,
which could be different than that of this example.
Use this token to authorize yourself from now on.

- Test the token:

GET http://localhost:8080/api/test/user

Authorization: type: Bear Token

RESULT: User Content.


- Add a product (already inserted in the db) to the shopping cart (already inserted in the db):

POST http://localhost:8080/shopcart/add

body:{
    "quantity": 5,
    "cartid": 1,
    "prodid": 1
}

Authorization: type: Bear Token

RESULT: {
    "message": "Product has been added to the cart.",
    "id": 1
}


- Edit the quantity of a product in the shopping cart:

PUT http://localhost:8080/shopcart/editq

body:
{
    "cartItemId": 1,
    "quantity": 8
}

Authorization: type: Bear Token

RESPONSE: {
    "message": "1: quantity updated."
}


- Delete a product from the shopping cart:

DELETE http://localhost:8080/shopcart/remove/1

Authorization: type: Bear Token
```
