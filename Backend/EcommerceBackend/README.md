# E-commerce Backend

The application is based on Spring Boot framework, supporting Token based Authentication with JWT and Spring Security.
It uses Spring Data JPA to interact with PostgreSQL Database.

## Use the backend application with Docker

1. Run "./mvnw clean package -DskipTests" to create the backend jar. Alternatively, you can run the Gitlab CI/CD Pipeline which will do the build for you, after which you can download the jar and place it under the project's "target" folder.

2.1 For the Dev version, with hot reload and mocking, run "docker compose -f docker-compose.dev.yml up" or "docker compose -f docker-compose.dev.yml up -d", if you want your containers to be running in the background. For stopping the backend, run "docker compose down"

2.2 For the Production version, run "docker compose up" or "docker compose up -d", if you want your containers to be running in the background. For stopping the backend, run "docker compose down"

3. See "Interact with the Services" for testing or integrating the APIs

## Use the backend application without Docker

### Run the Database

The first time you execute the procedure on MacOs/Linux:

```
docker load < mon-pg.tar docker run --name mon-pg -p 5432:5432 -e POSTGRES_PASSWORD=xyz -d postgres docker start mon-pg
```

And on Windows:

```
docker load -i mon-pg.tar; docker run --name mon-pg -p 5432:5432 -e POSTGRES_PASSWORD=xyz -d postgres; docker start mon-pg
```

Otherwise, just make sure that the container "mon-ecom-pg" is active, since it contains the PostgreSQL Server.
Instead, the e-commerce schema is automatically generated by the application thanks to Hibernate.

### Set the following environment variable with the POSTGRES_PASSWORD:

```
export POSTGRES_DB_PASSWORD= POSTGRES_PASSWORD
```

### Run the Spring Boot application

```
./mvnw spring-boot:run
```

### Run the following SQL insert statements

The first time you run the application, insert these data into the Database by hand (since we don't have any kind of APIs for this of operation yet):

```
INSERT INTO roles(id,name) VALUES(1,'ROLE_USER');
INSERT INTO roles(id,name) VALUES(2,'ROLE_ADMIN');
ALTER SEQUENCE roles_id_seq RESTART WITH 3;
INSERT INTO login_user(id, username, email, password, phone, firstname, lastname, isbuyer, isseller) VALUES (1, 'username', 'username@gmail.com', '$2a$10$9cOQijrPNVgUeMzqnSI1PezrYpZ07TwoSnrtxJWK/PSz9jSxAJt8a', 3467867981, 'firstname', 'lastname', true, true);
ALTER SEQUENCE login_user_id_seq RESTART WITH 2;
INSERT INTO user_roles(user_id, role_id) VALUES(1, 1);
INSERT INTO product_category(id,category_name) VALUES(1,'food');
ALTER SEQUENCE product_category_id_seq RESTART WITH 2;
INSERT INTO product(id,description,instock,name,price,product_category_id,login_user_id) VALUES(1,'super random pizza', true,'pizza', 8, 1, 1);
INSERT INTO product(id,description,instock,name,price,product_category_id,login_user_id) VALUES(2,'super test pizza', true,'pizza', 6, 1, 1);
INSERT INTO product(id,description,instock,name,price,product_category_id,login_user_id) VALUES(3,'random burger', true,'burger', 5, 1, 1);
INSERT INTO product(id,description,instock,name,price,product_category_id,login_user_id) VALUES(4,'random pasta', true,'pasta', 3, 1, 1);
ALTER SEQUENCE product_id_seq RESTART WITH 5;
commit;

```

## Interact with the services

The application automatically generates the documentation about the available endpoints, thanks to Swagger, here:

```
http://localhost:8080/swagger-ui/index.html
```

### Postman

Use this tool to test the endpoints:

1)Test public resources:

```
 GET http://localhost:8080/api/test/all

 RESULT: Public Content.
```

2)Test user resources:
(the body must be in JSON format)
``` 
- Create an account:

POST http://localhost:8080/api/auth/signup

body: {

    "username": "test123",
    "email": "test123@gmail.com",
    "password": "testpassw",
    "phone": "3456787981",
    "firstname": "test_name",
    "lastname": "test_surname",
    "isbuyer": true,
    "isseller": true,
    "role": ["user"]
}

RESULT: {
    "message": "User successfully registered with basic permissions!",
    "id": 2
}


- Login with the credentials:

POST http://localhost:8080/api/auth/signin

body: {
"username": "test123",
"password": "testpassw"
}

RESULT: {
    "id": 2,
    "username": "test_username",
    "email": "test123@gmail.com",
    "roles": [
        "ROLE_USER"
    ],
    "accessToken": "eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJ0ZXN0X3VzZXJuYW1lIiwiaWF0IjoxNjgxNTQ2ODg2LCJleHAiOjE2ODE2MzMyODZ9.NvMtcFWM3t1dHQa2hFrp_4HA6fRkYARyAq6ZJtPq6hIrUuetsmizZj4j-YZuj1WHMnmJImCYSZCAdrLLAZyMSg",
    "tokenType": "Bearer"
}

- From now on log in use the following test account already inserted in the db:

  body: {
  "username" = "username"
  "password" = "password"
  }

Take note of the generated bear token,
which could be different than that of this example.
Use this token to authorize yourself from now on.

- Test the token:

GET http://localhost:8080/api/test/user

Authorization: type: Bear Token

RESULT: User Content.


- Add a product (already inserted in the db) to the shopping cart (already inserted in the db):

POST http://localhost:8080/shopcart/add

body:{
    "prodid": 1,
    "quantity": 5
}

Authorization: type: Bear Token

RESULT: {
    "message": "A new Shopping has been created. The product has been added to the cart.",
    "id": 1
}


- Edit the quantity of a product in the shopping cart:

PUT http://localhost:8080/shopcart/editq

body:
{
    "cartItemId": 1,
    "quantity": 8
}

Authorization: type: Bear Token

RESPONSE: {
    "message": "1: quantity updated."
}


- Delete a product from the shopping cart:

DELETE http://localhost:8080/shopcart/remove/1

Authorization: type: Bear Token

RESPONSE: {
    "message": "Item has been removed from the cart."
}

- Search products by name (public API, no autorization required):

GET http://localhost:8080/product/search/name/pizza

RESPONSE: [
{
        "id": 1,
        "name": "pizza",
        "description": "super random pizza",
        "categoryName": "food",
        "media": null,
        "instock": true,
        "price": 8.0
    },
    {
        "id": 2,
        "name": "pizza",
        "description": "super test pizza",
        "categoryName": "food",
        "media": null,
        "instock": true,
        "price": 6.0
    }
]

- Search products by category (public API, no autorization required):

GET http://localhost:8080/product/search/category/food

RESPONSE:[
  {
        "id": 1,
        "name": "pizza",
        "description": "super random pizza",
        "categoryName": "food",
        "media": null,
        "instock": true,
        "price": 8.0
    },
    {
        "id": 2,
        "name": "pizza",
        "description": "super test pizza",
        "categoryName": "food",
        "media": null,
        "instock": true,
        "price": 6.0
    },
    {
        "id": 3,
        "name": "burger",
        "description": "random burger",
        "categoryName": "food",
        "media": null,
        "instock": true,
        "price": 5.0
    },
    {
        "id": 4,
        "name": "pasta",
        "description": "random pasta",
        "categoryName": "food",
        "media": null,
        "instock": true,
        "price": 3.0
    }
]

- Search products by instock (public API, no autorization required):

GET http://localhost:8080/product/search/instock/true

REPONSE:[
  {
        "id": 1,
        "name": "pizza",
        "description": "super random pizza",
        "categoryName": "food",
        "media": null,
        "instock": true,
        "price": 8.0
    },
    {
        "id": 2,
        "name": "pizza",
        "description": "super test pizza",
        "categoryName": "food",
        "media": null,
        "instock": true,
        "price": 6.0
    },
    {
        "id": 3,
        "name": "burger",
        "description": "random burger",
        "categoryName": "food",
        "media": null,
        "instock": true,
        "price": 5.0
    },
    {
        "id": 4,
        "name": "pasta",
        "description": "random pasta",
        "categoryName": "food",
        "media": null,
        "instock": true,
        "price": 3.0
    }
]

- Add a new product sold by the test user:

POST http://localhost:8080/product/add

Authorization: type: Bear Token

{
   "category_name": "food",
   "description": "just a type of pasta",
   "instock": true,
   "price": 4,
   "name": "spaghetti"
}

RESPONSE: {
    "message": "message": "Product correctly added."
}

- Add user's address:

POST http://localhost:8080/user/address/add

Authorization: type: Bear Token

body: {
    "city": "Rome",
    "country": "Italy",
    "receiver": "Marco Rossi",
    "postal_code": 00042,
    "street": "Via del Quirinale",
    "street_nr": 9
}

RESPONSE: {
    "message": "Address correctly added to the User."
}

- Modify default user's address:

PUT http://localhost:8080/user/address/make/default/1

Authorization: type: Bear Token

RESPONSE: {
    "message": "Address has been set has default address."
}

- Delete user's address:

DELETE: http://localhost:8080/user/address/remove/1

Authorization: type: Bear Token

RESPONSE: {
    "message": "Address has been removed from the user's list."
}
```
